<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyBOQ Deployment UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
  </head>
  <body class="bg-gray-100 dark:bg-gray-900 flex items-center justify-center h-screen text-gray-900 dark:text-gray-100">
    <!-- Popup Notification -->
    <div
      id="popup-notification"
      class="fixed inset-0 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-black bg-opacity-50 absolute inset-0"></div>
      <div
        id="popup-content"
        class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 mx-4 relative z-10 max-w-md w-full text-center"
      >
        <div id="popup-message" class="text-lg font-medium"></div>
      </div>
    </div>

    <!-- Token Input Modal -->
    <div
      id="token-modal"
      class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 hidden"
    >
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4 text-center">
          Enter GitHub Personal Access Token
        </h2>
        <input
          type="password"
          id="token-input"
          class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
        />
        <button
          id="token-submit"
          class="mt-4 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none"
        >
          Save Token
        </button>
      </div>
    </div>

    <!-- Theme Toggle + Logout Buttons -->
    <div class="absolute top-4 right-4 flex space-x-3 items-center">
      <!-- Theme Toggle Button -->
      <button
        id="theme-toggle"
        class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-yellow-300 p-2 rounded-full shadow-md hover:bg-gray-300 dark:hover:bg-gray-600 focus:outline-none transition-all"
      >
        <svg id="theme-icon" xmlns="http://www.w3.org/2000/svg"
             class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
          <path d="M17.293 13.293a8 8 0 11-10.586-10.586 
                   8.001 8.001 0 0010.586 10.586z"/>
        </svg>
      </button>

      <!-- Logout Button -->
      <div class="group relative">
        <button
          id="logout-btn"
          class="flex items-center space-x-2 bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-full shadow-lg hover:from-red-600 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 transition-all"
        >
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5" fill="none" viewBox="0 0 24 24"
               stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 
                     01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 
                     2 0 012 2v1"/>
          </svg>
          <span>Log Out</span>
        </button>
        <div
          class="absolute right-0 mt-2 w-64 px-3 py-2 bg-black text-white text-sm rounded-md opacity-0 group-hover:opacity-100 transition-opacity shadow-md"
        >
          Logging out will clear your token.
        </div>
      </div>
    </div>

    <!-- Main Card -->
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-xl">
      <h1 class="text-2xl font-bold mb-6 text-center">MyBOQ Deployment</h1>
      <div class="mb-4">
        <h2 class="text-lg font-bold mb-2">Deployment History</h2>
        <div class="overflow-y-auto h-48 border border-gray-300 dark:border-gray-600 rounded-md">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Deploy Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Version</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">JAR Name</th>
              </tr>
            </thead>
            <tbody id="history-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              <!-- Rows populated dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="mb-4">
        <label for="jar-file" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Select JAR File</label>
        <select
          id="jar-file"
          class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
        ></select>
      </div>
      <div class="mb-4">
        <label for="version" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Version Number (e.g., 1.01.02)</label>
        <input
          type="text"
          id="version"
          class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
          placeholder="Enter version number"
        />
        <p id="previous-version" class="text-sm text-gray-500 dark:text-gray-400 mt-1">
          Loading previous version...
        </p>
      </div>
      <!-- Deploy Button -->
      <button
        id="deploy-btn"
        class="w-full flex items-center justify-center space-x-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white py-2 px-4 rounded-full shadow-lg hover:from-indigo-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 transition-all"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5"
             fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 13l4 4L19 7"/>
        </svg>
        <span>Deploy</span>
      </button>
      <div id="output" class="mt-4 text-sm text-gray-700 dark:text-gray-300"></div>
    </div>

    <script>
      // --- Theme Toggle ---
      const themeToggleBtn = document.getElementById("theme-toggle");
      const themeIcon = document.getElementById("theme-icon");

      function setTheme(mode) {
        if (mode === "dark") {
          document.documentElement.classList.add("dark");
          localStorage.setItem("theme", "dark");
          themeIcon.innerHTML = `<path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 
                           1 0 11-2 0V3a1 1 0 011-1zm4.22 2.47a1 1 0 
                           011.42 0l.71.7a1 1 0 01-1.42 1.42l-.7-.71a1 
                           1 0 010-1.41zM18 11a1 1 0 100 2h1a1 1 0 
                           100-2h-1zm-2.64 6.36a1 1 0 011.41 
                           1.41l-.7.71a1 1 0 01-1.42-1.42l.71-.7zM11 
                           18a1 1 0 112 0v1a1 1 0 11-2 0v-1zm-7.07-.64a1 
                           1 0 010 1.41l-.71.71a1 1 0 
                           01-1.41-1.42l.7-.7a1 1 0 011.42 0zM4 
                           11a1 1 0 100 2H3a1 1 0 100-2h1zm2.34-6.36a1 
                           1 0 00-1.41-1.41l-.71.7a1 1 0 
                           001.42 1.42l.7-.71zM12 6a6 6 0 
                           100 12 6 6 0 000-12z" clip-rule="evenodd"/>`; // Sun
        } else {
          document.documentElement.classList.remove("dark");
          localStorage.setItem("theme", "light");
          themeIcon.innerHTML = `<path d="M17.293 13.293a8 8 0 
                                   11-10.586-10.586 
                                   8.001 8.001 0 0010.586 10.586z"/>`; // Moon
        }
      }

      // Apply saved theme on load
      setTheme(localStorage.getItem("theme") || "light");

      themeToggleBtn.addEventListener("click", () => {
        const current = localStorage.getItem("theme") === "dark" ? "dark" : "light";
        setTheme(current === "dark" ? "light" : "dark");
      });

      // --- Token Management ---
      function getToken() { return sessionStorage.getItem("GITHUB_PAT"); }
      function setToken(token) { sessionStorage.setItem("GITHUB_PAT", token); }
      function clearToken() { sessionStorage.removeItem("GITHUB_PAT"); }
      function showTokenModal() { document.getElementById("token-modal").classList.remove("hidden"); }
      function hideTokenModal() { document.getElementById("token-modal").classList.add("hidden"); }
      async function ensureToken() {
        let token = getToken();
        if (!token) { showTokenModal(); throw new Error("No token available"); }
        return token;
      }

      // --- Notification ---
      function showPopupNotification(message, isSuccess) {
        const popup = document.getElementById("popup-notification");
        const popupContent = document.getElementById("popup-content");
        const popupMessage = document.getElementById("popup-message");
        popupMessage.textContent = message;
        popupContent.className =
          "rounded-lg shadow-xl p-6 mx-4 relative z-10 max-w-md w-full text-center border-l-4 " +
          (isSuccess ? "border-green-500 bg-white dark:bg-gray-800" : "border-red-500 bg-white dark:bg-gray-800");
        popupMessage.className =
          "text-lg font-medium " + (isSuccess ? "text-green-600" : "text-red-600");
        popup.classList.remove("hidden");
        setTimeout(() => popup.classList.add("hidden"), 5000);
      }

      // --- API Calls ---
      async function fetchWithAuth(url, options = {}) {
        const token = await ensureToken();
        const headers = {
          Authorization: `Bearer ${token}`,
          Accept: "application/vnd.github.v3+json",
          ...options.headers,
        };
        const response = await fetch(url, { ...options, headers });
        if (response.status === 401) {
          clearToken(); showTokenModal(); throw new Error("Unauthorized - invalid token");
        }
        return response;
      }

      async function fetchJarFiles() {
        try {
          const response = await fetchWithAuth(
            "https://api.github.com/repos/Dhanashri-Mahade/demo-backend-app/contents/?ref=backup"
          );
          const data = await response.json();
          const jarFiles = data.filter((f) => f.name.endsWith(".jar")).map((f) => f.name);
          const select = document.getElementById("jar-file");
          select.innerHTML = "";
          if (jarFiles.length === 0) {
            select.innerHTML = '<option value="">No JAR files found</option>';
          } else {
            jarFiles.forEach((jar) => {
              const option = document.createElement("option");
              option.value = jar;
              option.textContent = jar;
              select.appendChild(option);
            });
          }
        } catch (error) {
          console.error("Error fetching JAR files:", error);
        }
      }

      async function fetchPreviousVersion() {
        try {
          const response = await fetchWithAuth(
            "https://api.github.com/repos/Dhanashri-Mahade/demo-backend-app/contents/deploy.env?ref=backup"
          );
          const data = await response.json();
          const content = atob(data.content);
          const lines = content.split("\n").map((l) => l.trim()).filter((l) => l !== "");
          const lastDate = lines.find((l) => l.startsWith("LAST_DATE="))?.split("=")[1] || "unknown";
          const lastVersion = lines.find((l) => l.startsWith("LAST_VERSION="))?.split("=")[1] || "unknown";
          const lastJar = lines.find((l) => l.startsWith("LAST_JAR="))?.split("=")[1] || "unknown";
          document.getElementById("version").value = lastVersion;
          document.getElementById("previous-version").textContent =
            `Previous version: ${lastVersion} deployed on ${lastDate} with JAR ${lastJar}`;
          const historyIndex = lines.findIndex((l) => l === "HISTORY=");
          const tbody = document.getElementById("history-table-body");
          tbody.innerHTML = "";
          if (historyIndex !== -1) {
            const historyLines = lines.slice(historyIndex + 1);
            const history = historyLines
              .map((line) => {
                const [date, version, jar] = line.split(",");
                const [dd, mm, yyyy] = date.split("-");
                const sortDate = new Date(yyyy, mm - 1, dd);
                return { date, version, jar, sortDate };
              })
              .filter((entry) => !isNaN(entry.sortDate.getTime()))
              .sort((a, b) => b.sortDate - a.sortDate);
            history.forEach((entry) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300">${entry.date}</td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300">${entry.version}</td>
                <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300">${entry.jar}</td>`;
              tbody.appendChild(row);
            });
          }
        } catch (error) {
          console.error("Error fetching deploy.env:", error);
        }
      }

      async function triggerWorkflow(selectedJar, version) {
        try {
          const response = await fetchWithAuth(
            "https://api.github.com/repos/Dhanashri-Mahade/demo-backend-app/actions/workflows/trigger-deploy.yml/dispatches",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                ref: "main",
                inputs: { jar_file: selectedJar, version: version },
              }),
            }
          );
          if (response.ok) {
            showPopupNotification("Workflow triggered successfully!", true);
          } else {
            const errorData = await response.json();
            showPopupNotification(`Failed: ${errorData.message || response.statusText}`, false);
          }
        } catch (error) {
          console.error("Error triggering workflow:", error);
          showPopupNotification("Error triggering workflow.", false);
        }
      }

      // --- Page Load ---
      window.onload = async () => {
        if (getToken()) { fetchJarFiles(); fetchPreviousVersion(); }
        else { showTokenModal(); }
      };

      // --- Token Submit ---
      document.getElementById("token-submit").addEventListener("click", () => {
        const token = document.getElementById("token-input").value.trim();
        if (token) {
          setToken(token); hideTokenModal(); fetchJarFiles(); fetchPreviousVersion();
        } else {
          alert("Please enter a token");
        }
      });

      // --- Logout Button ---
      document.getElementById("logout-btn").addEventListener("click", () => {
        clearToken(); showTokenModal();
      });

      // --- Deploy button ---
      document.getElementById("deploy-btn").addEventListener("click", async () => {
        const selectedJar = document.getElementById("jar-file").value;
        const version = document.getElementById("version").value;
        if (!selectedJar || !version) {
          showPopupNotification("Please select JAR and version.", false);
          return;
        }
        triggerWorkflow(selectedJar, version);
      });
    </script>
  </body>
</html>
