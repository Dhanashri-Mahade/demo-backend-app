name: 🚀 Deploy Spring Boot App to GCP VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      JAR_NAME: backend-${{ github.sha }}-${{ steps.build_time.outputs.time }}.jar

    steps:
      - name: 📦 Checkout Code
        uses: actions/checkout@v3

      - name: 🕒 Set Build Timestamp
        id: build_time
        run: echo "time=$(date +'%Y-%m-%d_%H-%M-%S')" >> "$GITHUB_OUTPUT"

      - name: 🧪 Set Commit Hash
        id: vars
        run: echo "commit_hash=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: ☕ Build Spring Boot App
        run: mvn clean package -DskipTests

      - name: 📂 Create dist Directory
        run: |
          mkdir -p dist
          cp target/*.jar dist/${{ env.JAR_NAME }}
          echo "GIT_COMMIT_HASH=${{ steps.vars.outputs.commit_hash }}" > dist/.env.production
          echo "BUILD_TIME=${{ steps.build_time.outputs.time }}" >> dist/.env.production

      - name: 🔑 Setup GCP Credentials
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY_JSON }}'

      - name: ☁️ Upload to GCS Current Bucket
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: dist/
          destination: ${{ secrets.GCP_BUCKET_CURRENT }}
          parent: false

      - name: ☁️ Upload to GCS Backup Bucket
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: dist/
          destination: ${{ secrets.GCP_BUCKET_BACKUP }}
          parent: false

      - name: 🔐 Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.GCP_VPS_HOST }} >> ~/.ssh/known_hosts

      - name: 🚀 Deploy to VPS via SSH
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.GCP_VPS_USER }}@${{ secrets.GCP_VPS_HOST }} << EOF
            mkdir -p ~/app/current ~/app/backup
            mv ~/app/current/*.jar ~/app/backup/ 2>/dev/null || true
            mv ~/app/current/.env.production ~/app/backup/ 2>/dev/null || true

            gsutil cp gs://${{ secrets.GCP_BUCKET_CURRENT }}/${{ env.JAR_NAME }} ~/app/current/
            gsutil cp gs://${{ secrets.GCP_BUCKET_CURRENT }}/.env.production ~/app/current/

            cd ~/app/current
            nohup java -jar ${{ env.JAR_NAME }} > app.log 2>&1 &
          EOF
