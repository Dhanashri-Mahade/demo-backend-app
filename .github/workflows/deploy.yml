name: 🚀 Deploy Spring Boot App (GitHub Backup Only)

on:
  push:
    branches: [main]

jobs:
  build-deploy-backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 👈 Required to push to backup branch

    steps:
      - name: 📦 Checkout Repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false # 👈 Disable default credentials

      - name: 🔧 Set up JDK 19
        uses: actions/setup-java@v3
        with:
          java-version: "19"
          distribution: "temurin"

      - name: 🛠️ Build JAR using Maven
        run: mvn clean package

      - name: 🏷️ Create .env.production
        id: versioning
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "version=$COMMIT_HASH" > .env.production
          echo "timestamp=$TIMESTAMP" >> .env.production
          echo "VERSION=$COMMIT_HASH-$TIMESTAMP" >> $GITHUB_ENV

      # ✅ Push backup JAR + .env.production to `backup` branch
      - name: 🔁 Push to backup branch on GitHub
        run: |
          git config user.name "Dhanashri-Mahade"
          git config user.email "dhanashrimahade@gmail.com"

          mkdir temp-backup
          cp target/*.jar temp-backup/backend-${{ env.VERSION }}.jar
          cp .env.production temp-backup/

          git fetch origin
          git switch backup

          cp temp-backup/* ./
          git add backend-${{ env.VERSION }}.jar .env.production
          git commit -m "🔁 Backup - ${{ env.VERSION }}" || echo "Nothing to commit"
          git push origin backup
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 👈 Use token explicitly
