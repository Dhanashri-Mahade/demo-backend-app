name: üöÄ Deploy Spring Boot App (Local Test + GitHub Backup)

on:
  push:
    branches: [main] # Trigger on main branch only

jobs:
  build-deploy-backup:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true # Required for pushing to another branch

      # 2. Setup Java & Maven
      - name: üîß Set up JDK 19
        uses: actions/setup-java@v3
        with:
          java-version: "19"
          distribution: "temurin"

      # 3. Build Spring Boot App
      - name: üõ†Ô∏è Build JAR using Maven
        run: mvn clean package

      # 4. Generate .env.production with version and timestamp
      - name: üè∑Ô∏è Create .env.production
        id: versioning
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "version=$COMMIT_HASH" > .env.production
          echo "timestamp=$TIMESTAMP" >> .env.production
          echo "VERSION=$COMMIT_HASH-$TIMESTAMP" >> $GITHUB_ENV

      # 5. Deploy to Local Physical Server
      - name: üìÇ Backup old & deploy new on Localhost
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            set -e
            APP_DIR='C:/Users/mahen/OneDrive/Desktop/dhanashri/siliconmount/demo-app'
            BACKUP_DIR=\"\$APP_DIR/backup\"
            CURRENT_DIR=\"\$APP_DIR/current\"
            TIMESTAMP=$(date +\"%Y%m%d%H%M%S\")

            mkdir -p \"\$BACKUP_DIR\" \"\$CURRENT_DIR\"

            if [ -f \"\$CURRENT_DIR/backend.jar\" ]; then
              mv \"\$CURRENT_DIR/backend.jar\" \"\$BACKUP_DIR/backend-\$TIMESTAMP.jar\"
            fi

            if [ -f \"\$CURRENT_DIR/.env.production\" ]; then
              mv \"\$CURRENT_DIR/.env.production\" \"\$BACKUP_DIR/.env.production-\$TIMESTAMP\"
            fi
          "

      - name: üì§ Transfer JAR and .env.production
        run: |
          scp target/*.jar ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:"C:/Users/mahen/OneDrive/Desktop/dhanashri/siliconmount/demo-app/current/backend.jar"
          scp .env.production ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:"C:/Users/mahen/OneDrive/Desktop/dhanashri/siliconmount/demo-app/current/.env.production"

      # 6. üîÅ Push backup files to `backup` branch
      - name: üîÅ Push to backup branch on GitHub
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          mkdir temp-backup
          cp target/*.jar temp-backup/backend-${{ env.VERSION }}.jar
          cp .env.production temp-backup/

          git fetch origin
          git switch backup

          cp temp-backup/* ./
          git add backend-${{ env.VERSION }}.jar .env.production
          git commit -m "üîÅ Backup - ${{ env.VERSION }}" || echo "Nothing to commit"
          git push origin backup
