name: 🚀 Deploy Spring Boot App to GCP VPS

on:
  push:
    branches: [main]

jobs:
  build-backup-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout code
      - name: 📦 Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Setup JDK for Maven build
      - name: ☕ Set up JDK 19
        uses: actions/setup-java@v3
        with:
          java-version: '19'
          distribution: 'temurin'

      # Step 3: Build the Spring Boot JAR
      - name: 🛠 Build JAR using Maven
        run: mvn clean package

      # Step 4: Generate version info and .env.production
      - name: 🏷 Create .env.production with version info
        id: versioning
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          VERSION="$COMMIT_HASH-$TIMESTAMP"
          echo "version=$COMMIT_HASH" > .env.production
          echo "timestamp=$TIMESTAMP" >> .env.production
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # Step 5: Authenticate gcloud using service account key
      - name: 🔐 Set up gcloud auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY_JSON }}'

      # Step 6: Upload JAR and .env.production to GCS Buckets
      - name: ☁ Upload to GCS Buckets
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: target/*.jar
          destination: '${{ secrets.GCP_BUCKET_CURRENT }}'
          parent: false

      - name: ☁ Upload .env.production to CURRENT bucket
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: .env.production
          destination: '${{ secrets.GCP_BUCKET_CURRENT }}'
          parent: false

      - name: ☁ Upload backup to BACKUP bucket
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: target/*.jar
          destination: '${{ secrets.GCP_BUCKET_BACKUP }}/backend-${{ env.VERSION }}.jar'
          parent: false

      # Step 7: Connect to VPS and deploy
      - name: 🚀 Deploy on GCP VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VPS_HOST }}
          username: ${{ secrets.GCP_VPS_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          script: |
            echo "📁 Moving to app directory..."
            cd ~/app

            echo "📦 Stopping old app if running..."
            pkill -f 'java -jar' || echo "App was not running."

            echo "🧹 Cleaning old .jar and .env.production..."
            rm -f app.jar .env.production

            echo "⬇️ Downloading new .jar and .env.production from GCS..."
            gcloud storage cp gs://${{ secrets.GCP_BUCKET_CURRENT }}/*.jar app.jar
            gcloud storage cp gs://${{ secrets.GCP_BUCKET_CURRENT }}/.env.production .

            echo "🚀 Starting new app..."
            nohup java -jar app.jar > output.log 2>&1 &
