name: â˜ï¸ Deploy Spring Boot App to Google Cloud

on:
  push:
    branches: [main]

jobs:
  build-upload-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code
      - name: ðŸ“¦ Checkout Repository
        uses: actions/checkout@v3

      # 2. Setup Java
      - name: â˜• Set up JDK 19
        uses: actions/setup-java@v3
        with:
          java-version: "19"
          distribution: "temurin"

      # 3. Build JAR
      - name: ðŸ› ï¸ Build Spring Boot App
        run: mvn clean package

      # 4. Generate .env.production with version info
      - name: ðŸ·ï¸ Create .env.production
        id: versioning
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "version=$COMMIT_HASH" > .env.production
          echo "timestamp=$TIMESTAMP" >> .env.production
          echo "VERSION=$COMMIT_HASH-$TIMESTAMP" >> $GITHUB_ENV

      # 5. Authenticate with Google Cloud
      - name: ðŸ” Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}

      # 6. Upload to springboot-current bucket
      - name: ðŸ“¤ Upload to Current Bucket
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: |
            target/*.jar
            .env.production
          destination: ${{ secrets.GCP_BUCKET_CURRENT }}
          parent: false

      # 7. Upload to springboot-backup bucket (versioned)
      - name: ðŸ—‚ï¸ Upload to Backup Bucket
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: target/*.jar
          destination: ${{ secrets.GCP_BUCKET_BACKUP }}/backend-${{ env.VERSION }}.jar
          parent: false

      - name: ðŸ—‚ï¸ Upload .env to Backup Bucket
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: .env.production
          destination: ${{ secrets.GCP_BUCKET_BACKUP }}/env-${{ env.VERSION }}.production
          parent: false

      # 8. SSH into GCP VPS and deploy
      - name: ðŸš€ Deploy to Google Cloud VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_VPS_HOST }}
          username: ${{ secrets.GCP_VPS_USER }}
          key: ${{ secrets.GCP_SSH_PRIVATE_KEY }}
          script: |
            # Install gsutil if not present
            if ! command -v gsutil &> /dev/null; then
              echo "Installing gsutil..."
              sudo apt-get update
              sudo apt-get install -y python3-pip
              pip3 install gsutil
            fi

            mkdir -p ~/app
            cd ~/app

            echo "ðŸ§¹ Cleaning old files..."
            rm -f backend.jar .env.production

            echo "â¬‡ï¸ Downloading JAR and .env from GCS..."
            gsutil cp gs://${{ secrets.GCP_BUCKET_CURRENT }}/*.jar backend.jar
            gsutil cp gs://${{ secrets.GCP_BUCKET_CURRENT }}/.env.production .env.production

            echo "ðŸ” Restarting Spring Boot App..."
            pkill -f 'java -jar' || true
            nohup java -jar backend.jar > app.log 2>&1 &
