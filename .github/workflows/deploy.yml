name: 🚀 Upload the Jar file on Github Branch

on:
  push:
    branches: [main]
    paths-ignore:
      - '.github/workflows/deploy-server.yml'
  pull_request:
    branches: [main]
    types: [closed]
  workflow_dispatch: # Adds manual trigger

permissions:
  contents: write
  packages: write

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      start_time: ${{ steps.ctx.outputs.start_time }}
      trigger_type: ${{ steps.ctx.outputs.trigger_type }}
    steps:
      - name: 🕒 Set START_TIME and TRIGGER_TYPE
        id: ctx
        shell: bash
        run: |
          START_TIME=$(TZ=Asia/Kolkata date +"%d-%m-%Y %H:%M")
          EVENT="${{ github.event_name }}"
          if [ "$EVENT" = "push" ]; then
            TRIGGER_TYPE="push"
          elif [ "$EVENT" = "workflow_dispatch" ]; then
            TRIGGER_TYPE="manual trigger"
          elif [ "$EVENT" = "pull_request" ] && [ "${{ github.event.pull_request.merged || false }}" = "true" ]; then
            TRIGGER_TYPE="merge"
          else
            TRIGGER_TYPE="$EVENT"
          fi
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "trigger_type=$TRIGGER_TYPE" >> $GITHUB_OUTPUT

  build-backup-deploy:
    needs: init
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    outputs:
      old_filename: ${{ steps.export_ctx.outputs.old_filename }}
      error_step: ${{ steps.capture_failure.outputs.error_step }}
    steps:
      # Step 1: Checkout main branch code
      - name: 📦 Checkout Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - run: echo "STEP_NAME=📦 Checkout Repository" >> $GITHUB_ENV

        # Step 2: Setup JDK for Maven build
      - name: ☕ Set up JDK 19
        uses: actions/setup-java@v3
        with:
          java-version: "19"
          distribution: "temurin"
      - run: echo "STEP_NAME=☕ Set up JDK 19" >> $GITHUB_ENV

      # Step 3: Build JAR using Maven
      - name: 🛠 Build JAR using Maven
        run: |
          echo "STEP_NAME=🛠 Build JAR using Maven" >> $GITHUB_ENV
          mvn clean package -X
          ls -la target/

      # Step 4: Verify JAR file exists
      - name: 🔍 Verify JAR file
        run: |
          echo "STEP_NAME=🔍 Verify JAR file" >> $GITHUB_ENV
          if [ ! -f target/*.jar ]; then
            echo "Error: No JAR file found"
            exit 1
          fi
          echo "JAR_FILE=$(ls target/*.jar)" >> $GITHUB_ENV

      # Step 5: Prepare backup branch and rename old JAR if exists
      - name: 📂 Prepare backup branch and rename old JAR
        run: |
          echo "STEP_NAME=📂 Prepare backup branch" >> $GITHUB_ENV
          git fetch origin
          git checkout backup || git checkout -b backup
          if [ -f "MyBOQ.jar" ] && [ -f ".env.production" ]; then
            OLD_DATE=$(grep '^date=' .env.production | cut -d'=' -f2)
            if [ -n "$OLD_DATE" ]; then
              OLD_FILENAME="MyBOQ_${OLD_DATE}.jar"
              mv MyBOQ.jar "${OLD_FILENAME}"
              git add "${OLD_FILENAME}"
              echo "OLD_FILENAME=${OLD_FILENAME}" >> $GITHUB_ENV
            fi
          fi

      #update deploy-server file code with new .jarnames
      - name: 🛠️ Update deploy-server.yml with new JAR + version info
        run: |
          OLD_FILENAME="${OLD_FILENAME}"

          # Fetch both branches
          git fetch origin main
          git fetch origin backup

          # Checkout main branch for editing workflows
          git checkout main

          # Ensure deploy-server.yml exists at correct path
          if [ ! -f .github/workflows/deploy-server.yml ]; then
            echo "❌ .github/workflows/deploy-server.yml not found in main branch!"
            exit 1
          fi

          echo "📦 Checking if $OLD_FILENAME exists in deploy-server.yml options list..."
          if grep -q "$OLD_FILENAME" .github/workflows/deploy-server.yml; then
            echo "✅ Already present, no update needed."
          else
            echo "➕ Adding $OLD_FILENAME to deploy-server.yml options..."
            awk -v new_option="          - $OLD_FILENAME" '
              /^ {10}- / { print; next }
              /options:/ {
                print;
                added=1;
                print new_option;
                next
              }
              {print}
            ' .github/workflows/deploy-server.yml > deploy-server.tmp.yml
            mv deploy-server.tmp.yml .github/workflows/deploy-server.yml
          fi

          # Grab deploy.env from backup branch
          git checkout origin/backup -- deploy.env
          PREV_VERSION=$(grep "VERSION=" deploy.env | cut -d= -f2)
          PREV_DATE=$(grep "DATE=" deploy.env | cut -d= -f2)

          echo "📋 Previous version found: $PREV_VERSION deployed on $PREV_DATE"

          # Update version input description in deploy-server.yml
          sed -i "/description: \"Enter new version number/ a\        description: \"Previous version: $PREV_VERSION deployed on $PREV_DATE\"" .github/workflows/deploy-server.yml

          # Commit and push changes using PAT
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add .github/workflows/deploy-server.yml
          git commit -m "Auto-update deploy-server.yml with $OLD_FILENAME and previous version info [skip ci]" || echo "No changes to commit"
          # Force Git to use PAT instead of GITHUB_TOKEN
          git remote set-url origin https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/Dhanashri-Mahade/demo-backend-app.git
          git push origin main

      # Step 6: Generate new .env.production with date, version, timestamp
      - name: 🏷 Create new .env.production
        run: |
          echo "STEP_NAME=🏷 Create new .env.production" >> $GITHUB_ENV
          TODAY=$(date +"%Y-%m-%d")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
          echo "date=$TODAY" > .env.production
          echo "version=$COMMIT_HASH" >> .env.production
          echo "timestamp=$TIMESTAMP" >> .env.production

      # Step 7: Copy and rename new JAR to MyBOQ.jar
      - name: 📦 Add new MyBOQ.jar
        run: |
          echo "STEP_NAME=📦 Add new MyBOQ.jar" >> $GITHUB_ENV
          cp "${{ env.JAR_FILE }}" MyBOQ.jar
          git add MyBOQ.jar .env.production

      # Step 8: Commit and push to backup branch
      - name: 🔁 Commit and push
        run: |
          echo "STEP_NAME=🔁 Commit and push" >> $GITHUB_ENV
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -m "🔁 Backup updated - $(date +"%Y-%m-%d %H:%M:%S")" || true
          git push origin backup --force

      - name: 🧾 Export notification context
        id: export_ctx
        if: always()
        run: echo "old_filename=${OLD_FILENAME:-}" >> $GITHUB_OUTPUT

      - name: 🚨 Capture failure step name
        id: capture_failure
        if: failure()
        run: echo "error_step=${STEP_NAME:-Unknown}" >> $GITHUB_OUTPUT

  # send success notification on mail
  notify-success:
    needs: [init, build-backup-deploy]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Get End Time
        id: get_end_time
        run: echo "end_time=$(TZ=Asia/Kolkata date '+%d-%m-%Y %H:%M')" >> $GITHUB_OUTPUT

      - name: 📧 Send success email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.titan.email
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "MyBOQ App Workflow - SUCCESS ✅"
          from: "MyBOQ Workflow <${{ secrets.SMTP_USERNAME }}>"
          to: "dhanashri.mahade@siliconmount.com"
          body: |
            📢 MyBOQ App Workflow Notification

            Your workflow has been started for MyBOQ App

            Trigger Type: ${{ needs.init.outputs.trigger_type }}
            Start Time: ${{ needs.init.outputs.start_time }}
            End Time: ${{ steps.get_end_time.outputs.end_time }}
            Status: ✅ SUCCESS

            Files updated in backup branch:
            1) MyBOQ.jar
            ${{ needs.build-backup-deploy.outputs.old_filename && format('2) {0}', needs.build-backup-deploy.outputs.old_filename) || '2) .env.production' }}

            Path: https://github.com/Dhanashri-Mahade/demo-backend-app/blob/backup/

            ---
            _Powered by GitHub Actions 🚀_

  # Send failure notification on mail
  notify-failure:
    needs: [init, build-backup-deploy]
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: 📧 Send failure email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.titan.email
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "MyBOQ App Workflow - FAILED ❌"
          from: "MyBOQ Workflow <${{ secrets.SMTP_USERNAME }}>"
          to: "dhanashri.mahade@siliconmount.com"
          body: |
            ⚠️ MyBOQ App Workflow Alert

            Your workflow for MyBOQ App has FAILED ❌

            Trigger Type: ${{ needs.init.outputs.trigger_type }}
            Start Time: ${{ needs.init.outputs.start_time }}
            Error Step: ${{ needs.build-backup-deploy.outputs.error_step }}

            📄 Check Logs:  
            https://github.com/Dhanashri-Mahade/demo-backend-app/actions

            ---
            _Powered by GitHub Actions 🚀 – Ensuring transparency in every build_
