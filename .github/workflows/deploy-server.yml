name: ðŸš€ðŸ”„ Deploy to Server

on:
  workflow_dispatch:
    inputs:
      jar_file:
        description: "Enter the .jar filename from backup branch"
        required: true
        type: choice
        options:
          - MyBOQ.jar
          - MyBOQ_2025-08-14.jar
          - MyBOQ_2025-08-15.jar
          - MyBOQ_2025-08-18.jar
          - MyBOQ_2025-08-19.jar
      version:
        description: "Enter new version number (e.g. 1.01.02)"
        required: true

permissions:
    contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout backup branch
        uses: actions/checkout@v3
        with:
          ref: backup

      - name: List available JAR files
        run: |
          echo "================================================="
          echo "Available JAR files in backup branch:"
          ls -1 *.jar || echo "No JAR files found!"
          echo "================================================="

      - name: Show previous version
        run: |
          if [ -f deploy.env ]; then
            echo "Previous version:"
            cat deploy.env
          else
            echo "No previous version found."
          fi

      - name: Show user inputs
        run: |
          echo "================================================="
          echo "User selected JAR file: ${{ github.event.inputs.jar_file }}"
          echo "User entered version: ${{ github.event.inputs.version }}"
          echo "================================================="

      # âœ… Fix: Rename only if not already MyBOQ.jar
      - name: Select and rename JAR
        run: |
          SELECTED="${{ github.event.inputs.jar_file }}"
          if [ "$SELECTED" != "MyBOQ.jar" ]; then
            echo "Renaming $SELECTED -> MyBOQ.jar"
            cp "$SELECTED" MyBOQ.jar
          else
            echo "Already MyBOQ.jar selected, skipping rename."
          fi

      - name: Update deploy.env with new version
        run: |
          NEW_VERSION=${{ github.event.inputs.version }}
          DATE=$(date +'%d-%m-%Y')
          echo "VERSION=$NEW_VERSION" > deploy.env
          echo "DATE=$DATE" >> deploy.env
          echo "Updated deploy.env:"
          cat deploy.env

      - name: Commit updated deploy.env
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add deploy.env
          git commit -m "Update version to ${{ github.event.inputs.version }}" || echo "No changes to commit"
          git push origin backup

      - name: Test SSH Connection
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "echo 'SSH working on Windows Server'"

      - name: Debug check files
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "dir C:\\Users\\root\\Jar"

      - name: Upload JAR to Windows Server
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          echo "Uploading MyBOQ.jar to server..."
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no MyBOQ.jar ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:"C:\\Users\\root\\Jar\\"

      # âœ… Stop old process and run new JAR
      - name: Restart Spring Boot App on Server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} powershell -Command "
            Write-Output 'Stopping any existing Spring Boot process...';
            Stop-Process -Name 'java' -Force -ErrorAction SilentlyContinue;

            Write-Output 'Starting new Spring Boot JAR...';
            Start-Process -NoNewWindow -FilePath 'java' -ArgumentList '-jar C:\\Users\\root\\Jar\\MyBOQ.jar'
          "
